name: Publish Wino Mail Release

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: Target branch to build from
        default: dev
        type: string
  schedule:
    - cron: "0 0 * * 1" # Every Monday at midnight UTC

env:
  target_branch: ${{ inputs.target_branch || 'dev' }}
jobs:
  fetch_info:
    name: Fetch release tags
    runs-on: ubuntu-latest
    outputs:
      latest_release_tag: ${{ steps.info.outputs.latest_release_tag }}
      latest_release_tag_parent: ${{ steps.info.outputs.latest_release_tag_parent }}
      parent_repo_url: ${{ steps.info.outputs.parent_repo_url }}
    steps:
      - name: Collect info about the current repository
        id: info
        uses: actions/github-script@v7
        with:
          script: |
            let latestRelease = { tag_name: "" };
            try {
              const { data } = await github.rest.repos.getLatestRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              latestRelease = data;
            } catch (error) {
              if (error.status !== 404) {
                throw error;
              }
            }

            const { data: { parent } } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const { data: latestReleaseParent } = await github.rest.repos.getLatestRelease({
              owner: parent.owner.login,
              repo: parent.name,
            });

            core.setOutput("latest_release_tag", latestRelease.tag_name);
            core.setOutput("latest_release_tag_parent", latestReleaseParent.tag_name);
            core.setOutput("parent_repo_url", parent.html_url);
  rebase:
    name: Rebase target branch
    needs: fetch_info
    if: needs.fetch_info.outputs.latest_release_tag != needs.fetch_info.outputs.latest_release_tag_parent
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@85e6279cec87321a52edac9c87bce653a07cf6c2
        with:
          ref: ${{ env.target_branch }}
      - name: Configure Git
        run: |
          git config --local user.name 'GitHub Actions'
          git config --local user.email 'github-actions[bot]@users.noreply.github.com'
      - name: Rebase taget branch on upstream branch
        run: |
          git remote add upstream ${{ needs.fetch_info.outputs.parent_repo_url }}.git
          git fetch upstream --tags
          git rebase ${{ needs.fetch_info.outputs.latest_release_tag_parent }}
      - name: Push changes
        run: git push origin ${{ env.target_branch }} --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    name: Build app
    needs: update-lockfiles
    uses: ./.github/workflows/build.yml
    with:
      target_branch: ${{ inputs.target_branch || 'dev' }}

  publish:
    name: Publish app
    needs: [build, fetch_info]

    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Download latest artifacts
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e
        with:
          pattern: Wino-Mail-*
      - name: Publish release
        uses: softprops/action-gh-release@ab50eebb6488051c6788d97fa95232267c6a4e23
        with:
          tag_name: ${{ needs.fetch_info.outputs.latest_release_tag_parent }}
          files: |
            **/*.appx
            **/*.msixbundle
